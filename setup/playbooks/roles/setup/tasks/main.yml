---
- debug: var=wapi_user
- debug: var=git_clone
- debug: var=git_version
- debug: var=os_version
- debug: var=required.os

- name: Ensure pre-requiste
  assert:
    that:
      - os_version in required.os

- name: Deploy from git
  become: true
  become_user: "{{ wapi_user }}"
  when: git_clone
  block:
  
    - name: Clone git wapi repo on user home
      become: true
      become_user: "{{ wapi_user }}"
      git:
        repo: "{{ git_repo }}"
        version: "{{ git_version }}"
        dest: /home/{{ wapi_user }}/{{ git_name }}
        force: yes

- name: Config
  become: yes
  become_user: root
  block:

    - name: Deploy wapi liftree config include
      copy:
        dest: /etc/liftree/conf.d/50-wapi.conf
        content: |
          ---
          name: /home/{{ wapi_user }}/{{ git_name }}/liftree
          ...

    - name: Create configuration directory
      file:
        path: /etc/wapi
        state: directory

    - name: Deploy wapi configs
      template:
        src: "{{ item }}"
        dest: /etc/wapi/{{ item }}
      loop:
        - "wapi.yml"
        - "runs.yml"

    - name: Display test url
      debug: msg="Go on http://{{ ansible_default_ipv4.address }}/show to test"
...